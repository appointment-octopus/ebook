<!DOCTYPE HTML>
<html lang="pt-br" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>1. Construindo Um Container Mínimo - Guia para Devs Deslocados</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../1_Introdução/index.html"><strong aria-hidden="true">1.</strong> Introdução</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../1_Introdução/1_Sofisticação Técnica - Como se virar/index.html"><strong aria-hidden="true">1.1.</strong> Sofisticação Técnica - Como Se Virar</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../1_Introdução/1_Sofisticação Técnica - Como se virar/1_Como Googlar.html"><strong aria-hidden="true">1.1.1.</strong> Como Googlar</a></li></ol></li><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/index.html"><strong aria-hidden="true">1.2.</strong> Resumão. Linux</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/1_Resumo Linux.html"><strong aria-hidden="true">1.2.1.</strong> Resumo Linux</a></li><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/2_Linux.html"><strong aria-hidden="true">1.2.2.</strong> Linux</a></li><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/3_5_windows wsl.html"><strong aria-hidden="true">1.2.3.</strong> Windows Wsl</a></li><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/3_Dual Boot.html"><strong aria-hidden="true">1.2.4.</strong> Dual Boot</a></li><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/4_Terminal.html"><strong aria-hidden="true">1.2.5.</strong> Terminal</a></li><li class="chapter-item "><a href="../../../1_Introdução/2_Resumão_Linux/FAQ.html"><strong aria-hidden="true">1.2.6.</strong> Faq</a></li></ol></li><li class="chapter-item "><a href="../../../1_Introdução/3_Git/index.html"><strong aria-hidden="true">1.3.</strong> Git</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../1_Introdução/3_Git/1_Resumão.html"><strong aria-hidden="true">1.3.1.</strong> Resumão</a></li><li class="chapter-item "><a href="../../../1_Introdução/3_Git/2_Git & Github.html"><strong aria-hidden="true">1.3.2.</strong> Git &amp; Github</a></li><li class="chapter-item "><a href="../../../1_Introdução/3_Git/3_Instalação e Configuração.html"><strong aria-hidden="true">1.3.3.</strong> Instalação E Configuração</a></li><li class="chapter-item "><a href="../../../1_Introdução/3_Git/4_Principais comandos.html"><strong aria-hidden="true">1.3.4.</strong> Principais Comandos</a></li><li class="chapter-item "><a href="../../../1_Introdução/3_Git/5_FAQ.html"><strong aria-hidden="true">1.3.5.</strong> Faq</a></li></ol></li><li class="chapter-item expanded "><a href="../../../1_Introdução/4_Ambientação/index.html"><strong aria-hidden="true">1.4.</strong> Ambientação</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/1_Arquitetura Cliente-Servidor.html"><strong aria-hidden="true">1.4.1.</strong> Arquitetura Cliente-Servidor</a></li><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/2_Projeto Completo em Javascript/index.html"><strong aria-hidden="true">1.4.2.</strong> Projeto Completo Em Javascript</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/2_Projeto Completo em Javascript/1_Backend.html"><strong aria-hidden="true">1.4.2.1.</strong> Backend</a></li><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/2_Projeto Completo em Javascript/2_Frontend.html"><strong aria-hidden="true">1.4.2.2.</strong> Frontend</a></li></ol></li><li class="chapter-item expanded "><a href="../../../1_Introdução/4_Ambientação/3_Docker/index.html"><strong aria-hidden="true">1.4.3.</strong> Docker</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../1_Introdução/4_Ambientação/3_Docker/1_Construindo um container mínimo.html" class="active"><strong aria-hidden="true">1.4.3.1.</strong> Construindo Um Container Mínimo</a></li><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/3_Docker/2_Diferenças entre VMs e Containers.html"><strong aria-hidden="true">1.4.3.2.</strong> Diferenças Entre Vms E Containers</a></li><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/3_Docker/3_Conceitos de Docker.html"><strong aria-hidden="true">1.4.3.3.</strong> Conceitos De Docker</a></li><li class="chapter-item "><a href="../../../1_Introdução/4_Ambientação/3_Docker/4_Instalação do Docker.html"><strong aria-hidden="true">1.4.3.4.</strong> Instalação Do Docker</a></li></ol></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../2_Aplicação/index.html"><strong aria-hidden="true">2.</strong> Aplicação</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../2_Aplicação/1_Docs/index.html"><strong aria-hidden="true">2.1.</strong> Docs</a></li><li class="chapter-item "><a href="../../../2_Aplicação/2_Backend/index.html"><strong aria-hidden="true">2.2.</strong> Backend</a></li><li class="chapter-item "><a href="../../../2_Aplicação/3_Frontend/index.html"><strong aria-hidden="true">2.3.</strong> Frontend</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Guia para Devs Deslocados</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/appointment-octopus/ebook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="construindo-um-container-mínimo"><a class="header" href="#construindo-um-container-mínimo">Construindo um container mínimo</a></h1>
<p><i class="hljs-comment" style="background-color: rgba(0,0,0,0)">Tempo estimado de leitura: 11min</i></p><br />
<p>Para a construção desse container, precisaremos, basicamente, de 4 coisas:</p>
<ul>
<li>
<p><code>chroot</code>: significa <strong>change root</strong>. traz <strong>isolamento</strong> pro nosso container; ao utilizar isso, cria-se um novo processo que têm o root aparente modificado. Ou seja, dentro desse novo root, voce é incapaz de modificar os arquivos do root original.</p>
</li>
<li>
<p><code>namespace</code>: feature do kernel Linux que traz <strong>isolamento</strong>; basicamente, um container não consegue visualizar/manipular recursos de outros containers (ou do próprio host) [o host também não consegue visualizar os recursos/processos dentro dos containers]</p>
<ul>
<li><strong>controla o que voce pode ver/fazer</strong></li>
</ul>
</li>
<li>
<p><code>cgroup</code>: significa <strong>control group</strong>. traz o controle de recursos; basicamente, voce pode especificar quanto de RAM, CPU etc aquele container poderá utilizar (de outra forma, ele tem acesso ilimitado aos recursos do host*)</p>
<ul>
<li><strong>controla o que voce pode usar</strong></li>
</ul>
</li>
<li>
<p><code>overlay</code>: um dos sistemas de arquivos utilizados no kernel*. traz a <strong>integridade</strong> da imagem. ou seja, permite criar uma imagem limpa que será utilizada como base pra construção de containers. dessa forma, vc pode manipular os conteudos dos containers (adicionar libs arquivos, etc), mas isso não modificará a imagem original</p>
<blockquote>
<p>*existem inumeros tipos de filesystems (sistemas de arquivos); para listar os disponiveis no seu computador, rode o comando <code>cat /proc/filesystems</code></p>
</blockquote>
<p>exemplo de alguns:</p>
<blockquote>
<p>rootfs: o core de um sistema linux. contém todas as aplicações, configurações, dispositivos etc necessários para rodar seu sistema Linux
<br /><br />procfs: um pseudo-filesystem que provê uma interface de comunicação entre o kernel e o usuario (é utilizado por exemplo pelo &quot;gerenciador de tarefas&quot; [system monitor] para visualizar os recursos atuais do pc etc)
<br /><br />ext2-4: o sistema de arquivos utilizado por sistemas Unix; lida com conceitos de blocos, inodes, diretorios etc</p>
</blockquote>
</li>
</ul>
<h2 id="resumo-dos-comandos"><a class="header" href="#resumo-dos-comandos">Resumo dos comandos</a></h2>
<p>Essa seção serve como um &quot;cheatsheet&quot; para recapitular quais comandos executar etc; caso seja a primeira vez lendo esse capitulo, pode passar para a proxima parte =)</p>
<p>Criando imagem do container (dentro da VM já):</p>
<pre><code class="language-bash">mkdir container_minimo &amp;&amp; cd &quot;$_&quot;

mkdir -p {,usr/}{{,s}bin,lib{,64}}

wget https://www.busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-i686 -O bin/busybox

chmod +x bin/busybox

chroot . /bin/busybox --install -s

cp /bin/bash bin/

cp /lib/x86_64-linux-gnu/libtinfo.so.6 /lib/x86_64-linux-gnu/libdl.so.2 /lib/x86_64-linux-gnu/libc.so.6 lib/

cp /lib64/ld-linux-x86-64.so.2 lib64/

cd
</code></pre>
<p>Criando o script <code>make_container.sh</code>:</p>
<pre><code class="language-bash">echo $'#!/bin/bash

IMAGE_PATH=$1

for ARGUMENT in &quot;$@&quot;
    do
    KEY=$(echo $ARGUMENT | cut -f1 -d=)
    VALUE=$(echo $ARGUMENT | cut -f2 -d=)

    case &quot;$KEY&quot; in
        CPU)   CPU=${VALUE} ;;
        RAM)   RAM=${VALUE} ;;     
        *)   
    esac    
done


function createRandomContainerName()
{
    local prefix=$(&lt;/dev/urandom tr -dc a-z | head -c 1)
    local randomName=$(&lt;/dev/urandom tr -dc a-z0-9_ | head -c 12)
    echo &quot;$prefix$randomName&quot;
}
containerName=$(createRandomContainerName)
export containerName


function prepareFoldersForOverlayFS() {
    mkdir -p /tmp/$containerName/{upper,workdir,overlay}
}


function createOverlayFS()
{
    mount -t \
        overlay -o lowerdir=$IMAGE_PATH,upperdir=/tmp/$containerName/upper,workdir=/tmp/$containerName/workdir \
        none \
        /tmp/$containerName/overlay
}


function installBusybox() {  
    chroot /tmp/$containerName/overlay/ /bin/busybox --install -s
}

function createCGroup() {
    sleep 1

    PID=$(ps aux | grep unshare | tail -2 | head -1 | awk \'{print $2}\') 
    
    cgcreate -a $containerName -g cpu,memory:$containerName

    set -x
    echo 5MB &gt; /sys/fs/cgroup/memory/$containerName/memory.limit_in_bytes
    echo 100 &gt; /sys/fs/cgroup/cpu/$containerName/cpu.shares

    # cgexec -g cpu,memory:$containerName $PID
    cgclassify -g cpu,memory:$containerName $PID
    set +x

    # Limit usage at 5% for a multi core system
    # cgset -r cpu.cfs_period_us=100 -r cpu.cfs_quota_us=$[ 5000 * $(getconf _NPROCESSORS_ONLN) ] $containerName

    # Set a limit of 80M
    # cgset -r memory.limit_in_bytes=80M $containerName
}

function setUpContainer() {
    export PS1=&quot;$containerName-# &quot;;
    mkdir proc;
    mount -t proc none proc;
    bash
}
export -f setUpContainer

function launchContainer() {
    unshare --mount --uts --ipc --net --pid --fork --user --map-root-user \
    chroot /tmp/$containerName/overlay \
    bash -c &quot;setUpContainer&quot;
}
export -f launchContainer

function makeContainer() {
    set -x

    sudo -u $containerName bash -c &quot;launchContainer&quot;

    set +x
}

prepareFoldersForOverlayFS
createOverlayFS
installBusybox
adduser --disabled-password --gecos &quot;&quot; $containerName
usermod -aG sudo $containerName
printf &quot;\n$containerName ALL=(ALL) NOPASSWD: /usr/sbin/chroot, /usr/bin/unshare\n&quot; &gt;&gt; /etc/sudoers

createCGroup &amp;

makeContainer
' &gt; make_container.sh
</code></pre>
<h2 id="instalando-uma-máquina-virtual-para-rodar-esse-tutorial"><a class="header" href="#instalando-uma-máquina-virtual-para-rodar-esse-tutorial">Instalando uma máquina virtual para rodar esse tutorial</a></h2>
<p>Para evitar poluir seu sistema operacional com esse tutorial, fazer testes livremente, vamos instalar uma VM (extremamente leve) para servir de sandbox:</p>
<table><thead><tr><th>#</th><th>Passo</th><th>Comando</th></tr></thead><tbody>
<tr><td>1</td><td>Instalar VirtualBox</td><td>Abra o link e selecione o metodo de sua preferencia: https://www.virtualbox.org/wiki/Linux_Downloads</td></tr>
<tr><td>2</td><td>Instalar <a href="https://github.com/ottomatica/bakerx">bakerX</a> <em>(front-end for creating and managing (micro) virtual environments)</em></td><td>Opção 1: <code>npm install ottomatica/bakerx -g</code><br />Opção 2: <a href="https://github.com/ottomatica/bakerx#installation">acesse o link</a></td></tr>
<tr><td>3</td><td>Baixar iso do ubuntu</td><td><code>bakerx pull focal cloud-images.ubuntu.com</code></td></tr>
<tr><td>4</td><td>Criar a VM</td><td><code>bakerx run construindo_container_minimo focal</code></td></tr>
<tr><td>5</td><td>Entrar na VM</td><td><code>bakerx ssh construindo_container_minimo</code></td></tr>
<tr><td>6</td><td>Garantir que sempre entraremos nessa VM como root</td><td><code>printf &quot;sudo -i\n&quot; &gt;&gt; ~/.bashrc &amp;&amp; exec $SHELL</code></td></tr>
<tr><td>6</td><td>Dar update p instalar alguns utilitarios</td><td><code>apt update</code></td></tr>
<tr><td>7</td><td>Instalar:<br /><code>tree</code> (listar diretorios e subdiretorios)</td><td><code>apt install tree</code></td></tr>
</tbody></table>
<h2 id="atenção"><a class="header" href="#atenção">Atenção</a></h2>
<p>Caso o terminal esteja tendo comportamento inesperado (ex: ao apertar Backspace, surge um espaço), talvez tenha que modificar o $TERM</p>
<pre><code class="language-console"># no seu pc mesmo, no host
~# echo $TERM
xterm-kitty
</code></pre>
<pre><code class="language-console"># na VM {que acessa com o bakerx}
~# echo &quot;export TERM=xterm&quot; &gt;&gt; ~/.bashrc
~# exec $SHELL
</code></pre>
<h2 id="preparando-um-diretorio-para-ser-nosso-container"><a class="header" href="#preparando-um-diretorio-para-ser-nosso-container">Preparando um diretorio para ser nosso container</a></h2>
<p>Ainda dentro de nossa VM (passo 5):</p>
<p>Vamos criar algumas pastas replicando o filesystem do Linux:</p>
<blockquote>
<p>Obs: omitirei o nome <code>root@ubuntu-focal:~# </code> aqui para poluir menos</p>
</blockquote>
<blockquote>
<p>Ou seja, no seu terminal você verá <code>root@ubuntu-focal:~# </code>, aqui no tutorial apenas <code>~#</code></p>
</blockquote>
<pre><code class="language-console">~# mkdir container_minimo &amp;&amp; cd &quot;$_&quot;

~/container_minimo# mkdir -p {,usr/}{{,s}bin,lib{,64}}
</code></pre>
<p>A estrutura atual da pasta deve estar assim:</p>
<pre><code class="language-console">~/container_minimo# tree

.
├── bin
├── lib
├── lib64
├── sbin
└── usr
    ├── bin
    ├── lib
    ├── lib64
    └── sbin

7 directories, 0 files
</code></pre>
<p>Vamos adicionar um pacote para utilizarmos dentro desse container que estamos criando?</p>
<p>Copie o pacote <code>ls</code> para a pasta atual:</p>
<pre><code class="language-console">~/container_minimo# cp /bin/ls bin/ls
</code></pre>
<p>Vamos rodar o comando <code>ls</code> dentro do nosso novo container (utilizando o comando <code>chroot</code>):</p>
<pre><code class="language-console">~/container_minimo# chroot . ls

chroot: can't execute 'ls': No such file or directory
</code></pre>
<p>Hmm... O problema é que esse comando (<code>ls</code>) necessita de algumas bibliotecas para funcionar. Felizmente, o comando <code>ldd</code> nos lista todas as dependencias que esse pacote possa ter:</p>
<pre><code class="language-console">~/container_minimo# ldd /bin/ls

	/lib/ld-musl-x86_64.so.1 (0x7f951dcf1000)
	libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f951dcf1000)
</code></pre>
<p>Agora, basta copiar essa biblioteca para nosso container:</p>
<pre><code class="language-console">~/container_minimo# cp /lib/ld-musl-x86_64.so.1 lib/.
</code></pre>
<p>Agora, vamos tentar novamente rodar <code>ls</code>:</p>
<pre><code class="language-console">~/container_minimo# chroot . ls /
bin   lib   sbin  usr
</code></pre>
<p>Funcionou :)</p>
<p>Vamos adicionar o <code>bash</code> também:</p>
<pre><code class="language-console">~/container_minimo# cp /bin/bash bin/

~/container_minimo# cp /lib/x86_64-linux-gnu/libtinfo.so.6 /lib/x86_64-linux-gnu/libdl.so.2 /lib/x86_64-linux-gnu/libc.so.6 lib/

~/container_minimo# cp /lib64/ld-linux-x86-64.so.2 lib64/
</code></pre>
<p>Entretanto, seria muito tedioso e exaustivo copiar cada comando que julgassemos necessarios (como, por exemplo, o shell <code>bash</code>, o comando <code>cp</code>, <code>mv</code> e assim por diante)</p>
<p>Portanto, vamos utilizar o <a href="https://en.wikipedia.org/wiki/BusyBox">Busybox</a> (= varios <a href="https://en.wikipedia.org/wiki/List_of_Unix_commands">comandos unix</a> uteis, como <code>cd</code>, <code>alias</code>, <code>mv</code> etc)</p>
<pre><code class="language-console">~/container_minimo# wget https://www.busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-i686 -O bin/busybox
</code></pre>
<p>Torne esse arquivo em executavel</p>
<pre><code class="language-console">~/container_minimo# chmod +x bin/busybox
</code></pre>
<p>Instale os symlinks dentro do container:</p>
<pre><code class="language-console">~/container_minimo# chroot . /bin/busybox --install -s
</code></pre>
<p>Verifique que agora existem inumeros pacotes dentro da pasta de binarios:</p>
<pre><code class="language-console">~/container_minimo# chroot . ls /bin/
</code></pre>
<h2 id="interagindo-com-nosso-container"><a class="header" href="#interagindo-com-nosso-container">Interagindo com nosso container</a></h2>
<p>Para entrarmos nesse nosso novo container (e utilizar o shell dentro do mesmo), basta rodar o comando <code>bash</code>:</p>
<pre><code class="language-console">~/container_minimo# PS1=&quot;C-$ &quot; chroot . bash
</code></pre>
<blockquote>
<p>o <code>PS1</code> modifica o prompt; é so para distinguirmos o nome do shell dentro do container em relação ao mundo externo :)</p>
</blockquote>
<p>Vamos criar um arquivo aleatorio dentro desse container:</p>
<pre><code class="language-console">C-$ touch teste.txt

C-$ ls

bin        lib        linuxrc    sbin       teste.txt  usr

C-$ exit
</code></pre>
<p>Agora que saímos do container (com o <code>exit</code>), podemos ver um problema. A modificação que fizemos dentro do container veio para o &quot;mundo real&quot;...</p>
<pre><code class="language-console">~/container_minimo# ls

bin        lib        linuxrc    sbin       teste.txt  usr
</code></pre>
<h3 id="aprimorando-nosso-container"><a class="header" href="#aprimorando-nosso-container">Aprimorando nosso container</a></h3>
<h4 id="overlay"><a class="header" href="#overlay">Overlay</a></h4>
<p>Para mantermos a integridade, vamos utilizar o overlayFS. Esse sistema consiste de 3 camadas:</p>
<ul>
<li>Lower: read-only, a imagem (não modificavel dentro do container) utilizada como base pra criação do container</li>
<li>Upper: read-write, onde será armazenado as modificações feitas</li>
<li>Overlay: o container de fato. a composição das duas camadas</li>
</ul>
<blockquote>
<p>existe ainda o <code>workdir</code>. mas ele não têm tanto valor semantico, é so um diretorio aleatorio utilizado pelo kernel enquanto ele monta o Overlay</p>
</blockquote>
<p><img src="https://imgur.com/ZA1vq3d.png" alt="overlay" /></p>
<p>Como bônus, vamos montar o filesystem <code>proc</code>, também, para monitorarmos os recursos dentro desse container.</p>
<p>Crie um novo arquivo dentro da VM (não container) chamado <code>make_container.sh</code> (e vamos sair dessa pasta do container, também):</p>
<pre><code class="language-console">~/container_minimo# cd
~# vim make_container.sh
</code></pre>
<p>Aperte <code>i</code> para entrar no modo inserção dentro do editor de texto <code>vim</code>, copie o codigo abaixo e cole (<code>ctrl + shift + v</code>)</p>
<pre><code class="language-bash">#!/bin/bash

CONTAINER_PATH=$1


function createRandomContainerName()
{
    local randomName=$(&lt;/dev/urandom tr -dc A-Za-z0-9-_ | head -c 10)
    echo &quot;$randomName&quot;
}


containerName=$(createRandomContainerName)


function prepareFoldersForOverlayFS()
{
    mkdir -p /tmp/$containerName/upper \
             /tmp/$containerName/workdir \
             /tmp/$containerName/overlay
}


function createOverlayFS()
{
    mount -t \
        overlay -o lowerdir=$CONTAINER_PATH,upperdir=/tmp/$containerName/upper,workdir=/tmp/$containerName/workdir \
        none \
        /tmp/$containerName/overlay
}


function installBusybox() {  
    chroot /tmp/$containerName/overlay/ /bin/busybox --install -s
}


function launchContainer() { 
    PS1=&quot;$containerName-# &quot; \
    chroot /tmp/$containerName/overlay \
    bash -c &quot;mkdir /proc;
    mount -t proc none /proc;
    bash&quot;
}


prepareFoldersForOverlayFS
createOverlayFS
installBusyLogarbox
launchContainer
</code></pre>
<p>Salve o arquivo (aperte <code>ESC</code>, digite <code>:wq</code> e aperte <code>ENTER</code>)</p>
<h4 id="vulnerabilidade-visualizando-recursos-que-não-deveria"><a class="header" href="#vulnerabilidade-visualizando-recursos-que-não-deveria">Vulnerabilidade: visualizando recursos que não deveria</a></h4>
<p>Para visualizarmos melhor o motivo de precisarmos de <code>namespaces</code>, façamos o seguinte:</p>
<p>Inicie um container no background (adicionando <code>&amp;</code> ao final do comando):</p>
<pre><code class="language-console">~# bash make_container.sh container_minimo/ &amp;
</code></pre>
<p>Vamos verificar qual o PID (process id) do mesmo:</p>
<pre><code class="language-console">~# ps aux | grep make_container.sh
1327 root      0:00 bash make_container.sh container_minimo/
1445 root      0:00 grep make_container.sh
</code></pre>
<p>Mas, quando se inicia um processo no background (utilizando o operador <code>&amp;</code>), podemos verificar o PID deste processo de forma mais simples:</p>
<pre><code class="language-console">~# echo $!
1327
</code></pre>
<p>Ok, sabemos agora que o PID desse container rodando no background é <code>1327</code>.
Logar
Vamos verificar quais processos são possiveis de ser visualizados dentro desse container:</p>
<pre><code class="language-console">qqyioEo0gM-# ps

...
 1097 0         0:00 sshd: root@pts/0
 1099 0         0:00 -ash
 1326 0         0:00 [kworker/u2:1-ev]
 1327 0         0:00 bash make_container.sh container_minimo/
 1337 0         0:00 bash
 1412 0         0:00 bash make_container.sh container_minimo/
 1422 0         0:00 bash
 1427 0         0:00 ps
</code></pre>
<p>Opa! Eu consigo visualizar o PID do outro container, o que é uma vulnerabilidade bem grande. Com isso, eu poderia encerrar o outro container facilmente:</p>
<pre><code class="language-console">qqyioEo0gM-# kill -9 1327
</code></pre>
<p>Saindo do container atual, vamos verificar se o container que estava em background ainda está em execução:</p>
<pre><code class="language-console">qqyioEo0gM-# exit
~# ps aux | grep make_container.sh
1447 root      0:00 grep make_container.sh
</code></pre>
<p>Logaro Namespace. De acordo com a <a href="https://en.wikipedia.org/wiki/Linux_namespaces">Wikipedia</a>:</p>
<pre><code class="language-text">Namespaces are a feature of the Linux kernel that partitions kernel resources such that one set of processes sees one set of resources while another set of processes sees a different set of resources. The feature works by having the same namespace for a set of resources and processes, but those namespaces refer to distinct resources. Resources may exist in multiple spaces. Examples of such resources are process IDs, hostnames, user IDs, file names, and some names associated with network access, and interprocess communication.

. . .

Three syscalls can directly manipulate namespaces:

clone,   flags to specify which new namespace the new process should be migrated to.

unshare,     allows a process (or thread) to disassociate parts of its execution context that are currently being shared with other processes (or threads)

setns,  enters the namespace specified by a file descriptor.
</code></pre>
<p>Para o nosso caso, utilizaremos o comando <a href="https://man7.org/linux/man-pages/man1/unshare.1.html"><code>unshare</code></a>.</p>
<p>Modifique a função <code>launchContainer()</code> dentro do arquivo <code>make_container.sh</code> da seguinte forma:</p>
<pre><code class="language-bash">function launchContainer() { 
    PS1=&quot;$containerName-# &quot; \
    unshare --mount --uts --ipc --net --pid --fork --user --map-root-user \
    chroot /tmp/$containerName/overlay \
    bash -c &quot;mkdir /proc;
    mount -t proc none /proc;
    bash&quot;
}
</code></pre>
<blockquote>
<p>existe uma flag do <code>unshare</code> que já monta o procfs para nós (<code>--mount-proc</code>), o que significa que bastaria instanciar o shell (sem necessidade de rodar a flag <code>-c</code> e os respectivos comandos criando &amp; montando o procfs)</p>
</blockquote>
<p>Vamos instanciar um processo aleatorio em background novamente:</p>
<pre><code class="language-console">~# sleep 6000 &amp;
</code></pre>
<p>Verificando qual o PID do mesmo:</p>
<pre><code class="language-console">~# echo $!
1107
</code></pre>
<p>Agora, vamos entrar num container e tentar encerrar esse processo:</p>
<pre><code class="language-console">uaLxGqwWPW-# kill -9 1107
bash: can't kill pid 1107: No such process
</code></pre>
<p>Epa! Vamos verificar quais processos podemos enxergar:</p>
<pre><code class="language-console">uaLxGqwWPW-# ps
PID   USER     TIME  COMMAND
    1 0         0:00 bash
    4 0         0:00 ps
</code></pre>
<p>Pronto! Criamos um novo namespace isolado do host :D</p>
<h4 id="cgroups"><a class="header" href="#cgroups">CGroups</a></h4>
<p>Bem, a ultima questão é o fato de que nosso container tem acesso irrestrito ao uso de recursos computacionais do host.</p>
<p>Significa que pode usar quanta cpu, ram etc precisar</p>
<p>Isso é um problema pois, imagine o seguite cenario:</p>
<pre><code class="language-text">voce tem um servidor com 500tb de armazenamento, 512gb de ram, cpu brabo etc
e ai decide alugar esse servidor da seguinte forma: 
qualquer pessoa manda o container da aplicação que tem, e esse servidor vai rodar elas

imagine que Joao mandou o container dele contendo o e-commerce dele, e a Ana mandou o container dela contendo um site de noticias

durante a black friday, houve um pico de acessos no e-commerce do joao, que sugou todos os recursos computacionais do servidor (host)

o servidor travou e, consequentemente, parou de rodar o container da Ana tambem
</code></pre>
<blockquote>
<p>obs: esse ~storytelling foi roubado <a href="https://btholt.github.io/complete-intro-to-containers/cgroups">daqui</a></p>
</blockquote>
<p>Vamo bota a mao na massa entao.</p>
<p>Primeiramente, vamos instalar o <code>cgroup-tools</code>:</p>
<pre><code class="language-console">~# apt install cgroup-tools -y
</code></pre>
<hr />
<p>Logar
Fontes:</p>
<ul>
<li>
<p>Rahul Singh: <a href="https://www.youtube.com/watch?v=uJbJKcUsILI">&lt;video 6min&gt; overlayFS | CVE-2021-3493 | Technical Details</a></p>
</li>
<li>
<p>School of Devops: <a href="https://www.youtube.com/watch?v=2ZdJ_3sBr6A">&lt;video 10min&gt; Lesson 4: Whats under the hood - Namespaces, Cgroups and OverlayFS</a></p>
</li>
<li>
<p>Archlinux: <a href="https://wiki.archlinux.org/title/Overlay_filesystem">&lt;artigo&gt; Overlay filesystem</a></p>
</li>
<li>
<p>Brian Holt (Frontend Masters, Microsoft): <a href="https://btholt.github.io/complete-intro-to-containers">&lt;artigo&gt;Complete intro to Containers</a></p>
</li>
<li>
<p>CSC-Devops (NC State University): <a href="https://github.com/CSC-DevOps/Containers">&lt;tutorial&gt;Containers</a></p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../1_Introdução/4_Ambientação/3_Docker/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../1_Introdução/4_Ambientação/3_Docker/2_Diferenças entre VMs e Containers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../1_Introdução/4_Ambientação/3_Docker/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../1_Introdução/4_Ambientação/3_Docker/2_Diferenças entre VMs e Containers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>



        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
